name: Security Scan Tools

on:
  pull_request:
    paths:
      - '**/*.py'
      - '**/conanfile.py'
      - '**/requirements*.txt'
      - '**/pyproject.toml'
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semgrep

      - name: Run Bandit security scan
        run: |
          echo "Running Bandit security scan..."
          bandit -r scripts/ -f json -o bandit-scripts-report.json || true
          bandit -r openssl_tools/ -f json -o bandit-tools-report.json || true
          bandit -r . -f json -o bandit-all-report.json || true

      - name: Run Safety dependency scan
        run: |
          echo "Running Safety dependency scan..."
          safety check --json --output safety-report.json || true

      - name: Run Semgrep security scan
        run: |
          echo "Running Semgrep security scan..."
          semgrep --config=auto scripts/ --json --output=semgrep-scripts-report.json || true
          semgrep --config=auto openssl_tools/ --json --output=semgrep-tools-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.run_id }}
          path: |
            bandit-*-report.json
            safety-report.json
            semgrep-*-report.json
          retention-days: 30

      - name: Security scan summary
        run: |
          echo "## 🔒 Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Scan Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository Type**: OpenSSL Tools" >> $GITHUB_STEP_SUMMARY
          echo "- **Scan Tools**: Bandit, Safety, Semgrep" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Directories**: scripts/, openssl_tools/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📊 Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit Scripts**: $(jq '.results | length' bandit-scripts-report.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit Tools**: $(jq '.results | length' bandit-tools-report.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety Issues**: $(jq '.vulnerabilities | length' safety-report.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep Scripts**: $(jq '.results | length' semgrep-scripts-report.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep Tools**: $(jq '.results | length' semgrep-tools-report.json 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📁 Generated Reports" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit Scripts**: bandit-scripts-report.json" >> $GITHUB_STEP_SUMMARY
          echo "- **Bandit Tools**: bandit-tools-report.json" >> $GITHUB_STEP_SUMMARY
          echo "- **Safety**: safety-report.json" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep Scripts**: semgrep-scripts-report.json" >> $GITHUB_STEP_SUMMARY
          echo "- **Semgrep Tools**: semgrep-tools-report.json" >> $GITHUB_STEP_SUMMARY