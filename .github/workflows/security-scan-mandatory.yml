name: 🔒 Mandatory Security Scan

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  CONAN_USER_HOME: ${{ github.workspace }}/.conan2
  CONAN_VERSION: ${{ vars.CONAN_VERSION || '2.21.0' }}
  PYTHON_VERSION: ${{ vars.PYTHON_VERSION || '3.12' }}

jobs:
  security-scan:
    name: 🔒 Security Scan (Mandatory)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pyyaml scipy cyclonedx-bom cyclonedx-python-lib

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: cyclonedx-json
          output-file: openssl-tools-sbom.json
          fail-on-error: true

      - name: Vulnerability Scan (Filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          fail-on-error: true

      - name: Container Image Scan (if Dockerfile exists)
        if: hashFiles('Dockerfile') != ''
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          scan-ref: 'openssl-tools:latest'
          format: 'sarif'
          output: 'trivy-image-results.sarif'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          fail-on-error: false

      - name: Dependency Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-deps-results.sarif'
          exit-code: '1'
          severity: 'HIGH,CRITICAL'
          fail-on-error: true

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: |
            openssl-tools-sbom.json
            trivy-fs-results.sarif
            trivy-deps-results.sarif
            trivy-image-results.sarif
          retention-days: 90

      - name: Security scan summary
        run: |
          echo "## 🔒 Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- **SBOM Generated**: ✅ CycloneDX format" >> $GITHUB_STEP_SUMMARY
          echo "- **Filesystem Scan**: ✅ HIGH/CRITICAL severity check" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Scan**: ✅ HIGH/CRITICAL severity check" >> $GITHUB_STEP_SUMMARY
          if [ -f "trivy-image-results.sarif" ]; then
            echo "- **Container Scan**: ✅ HIGH/CRITICAL severity check" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Security Status**: ✅ PASSED - Ready for merge" >> $GITHUB_STEP_SUMMARY

  security-gate:
    name: 🚪 Security Gate
    runs-on: ubuntu-latest
    needs: security-scan
    if: always()
    
    steps:
      - name: Check security scan results
        run: |
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "✅ Security scan passed - merge approved"
            echo "security_status=passed" >> $GITHUB_OUTPUT
          else
            echo "❌ Security scan failed - merge blocked"
            echo "security_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Security gate summary
        run: |
          echo "## 🚪 Security Gate Status" >> $GITHUB_STEP_SUMMARY
          echo "- **Required Checks**: ✅ All security scans passed" >> $GITHUB_STEP_SUMMARY
          echo "- **Merge Status**: ✅ APPROVED" >> $GITHUB_STEP_SUMMARY
          echo "- **Next Steps**: Ready for merge consideration" >> $GITHUB_STEP_SUMMARY