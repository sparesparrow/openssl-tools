name: Basic OpenSSL Integration Test

on:
  repository_dispatch:
    types: [openssl-build-triggered]
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - 'conanfile.py'
      - '.github/workflows/basic-openssl-integration-test.yml'

env:
  CONAN_VERSION: "2.0.17"

jobs:
  test-basic-openssl-build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout openssl-tools
        uses: actions/checkout@v4
        with:
          repository: sparesparrow/openssl-tools
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Checkout OpenSSL source
        uses: actions/checkout@v4
        with:
          repository: sparesparrow/openssl
          path: openssl-src
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Conan
        run: |
          pip install conan==${{ env.CONAN_VERSION }}
          conan --version
      
      - name: Copy conanfile.py to OpenSSL source
        run: |
          echo "ðŸ“‹ Copying conanfile.py to OpenSSL source..."
          cp conanfile.py openssl-src/
          ls -la openssl-src/conanfile.py
      
      - name: Validate OpenSSL source structure
        run: |
          echo "ðŸ” Validating OpenSSL source structure..."
          cd openssl-src
          test -f VERSION.dat || (echo "âŒ VERSION.dat not found" && exit 1)
          test -f Configure || (echo "âŒ Configure not found" && exit 1)
          test -f config || (echo "âŒ config not found" && exit 1)
          echo "âœ… OpenSSL source structure valid"
      
      - name: Test conanfile.py syntax
        run: |
          echo "ðŸ” Testing conanfile.py syntax..."
          cd openssl-src
          python -m py_compile conanfile.py
          echo "âœ… conanfile.py syntax valid"
      
      - name: Test Conan inspect
        run: |
          echo "ðŸ” Testing Conan inspect..."
          cd openssl-src
          conan inspect . --format=json > /dev/null
          echo "âœ… Conan inspect successful"
      
      - name: Test basic Conan configuration
        run: |
          echo "ðŸ” Testing basic Conan configuration..."
          cd openssl-src
          
          # Test version detection
          python3 -c "
          import sys
          sys.path.append('.')
          from conanfile import OpenSSLConan
          
          conan = OpenSSLConan()
          conan.recipe_folder = '.'
          conan.set_version()
          print(f'âœ… Version detection: {conan.version}')
          "
      
      - name: Test Conan profile validation
        run: |
          echo "ðŸ” Testing Conan profile validation..."
          cd openssl-src
          
          # Create a basic profile for testing
          mkdir -p conan-profiles
          cat > conan-profiles/test.profile << EOF
          [settings]
          os=Linux
          arch=x86_64
          compiler=gcc
          compiler.version=11
          compiler.libcxx=libstdc++11
          build_type=Release
          
          [options]
          openssl/*:shared=True
          openssl/*:fips=False
          openssl/*:no_asm=False
          EOF
          
          # Test profile validation
          conan profile show --profile=conan-profiles/test.profile
          echo "âœ… Profile validation successful"
      
      - name: Test Conan create (dry run)
        run: |
          echo "ðŸ” Testing Conan create (dry run)..."
          cd openssl-src
          
          # Test conan create without actually building
          conan create . --build=missing --profile=conan-profiles/test.profile --dry-run
          echo "âœ… Conan create dry run successful"
      
      - name: Report success
        run: |
          echo "ðŸŽ‰ Basic OpenSSL integration test completed successfully!"
          echo "âœ… All fundamental components working:"
          echo "  - OpenSSL source structure valid"
          echo "  - conanfile.py syntax valid"
          echo "  - Conan inspect working"
          echo "  - Version detection working"
          echo "  - Profile validation working"
          echo "  - Conan create dry run successful"
          echo ""
          echo "ðŸš€ Ready for actual build testing!"