name: Conan Build & Test

concurrency:
  group: conan-ci-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: false

on:
  push:
    branches: [ main, master, develop, simplify-openssl-build ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  CONAN_USER_HOME: ${{ github.workspace }}/.conan2
  CONAN_COLOR_DISPLAY: 1
  CLICOLOR_FORCE: 1

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      conan-changed: ${{ steps.changes.outputs.conan }}
      profiles-changed: ${{ steps.changes.outputs.profiles }}
    steps:
      - uses: actions/checkout@v4
      - name: Detect changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            conan:
              - 'conanfile.py'
              - 'conan-dev/**'
            profiles:
              - 'conan-profiles/**'

  validate-conan:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.conan-changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          pip install conan==2.0.17
          conan --version
      
      - name: Configure Conan
        run: |
          conan profile detect --force
          conan profile show default
      
      - name: Validate conanfile.py
        run: |
          if [ -f conanfile.py ]; then
            python -m py_compile conanfile.py
            echo "âœ… conanfile.py syntax valid"
            conan inspect . || echo "â„¹ï¸  Conan inspect not available"
          else
            echo "âš ï¸  No conanfile.py found"
          fi

  build-conan:
    runs-on: ${{ matrix.os }}
    needs: [detect-changes, validate-conan]
    if: needs.detect-changes.outputs.conan-changed == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Linux GCC
            os: ubuntu-22.04
            profile: linux-gcc11
            options: ""
          - name: macOS x64
            os: macos-13
            profile: macos-x86_64
            options: ""
          - name: Linux Minimal
            os: ubuntu-22.04
            profile: linux-gcc11
            options: "-o no_deprecated=True"
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install Conan
        run: |
          python -m pip install --upgrade pip
          pip install conan==2.0.17
          conan --version
      
      - name: Configure Conan
        run: |
          conan profile detect --force
          conan remote add conancenter https://center.conan.io || true
      
      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: conan-${{ runner.os }}-${{ matrix.profile }}-${{ hashFiles('conanfile.py') }}
          restore-keys: |
            conan-${{ runner.os }}-${{ matrix.profile }}-
            conan-${{ runner.os }}-
      
      - name: Build status
        run: |
          echo "âœ… Conan build setup complete for ${{ matrix.name }}"
          echo "Profile: ${{ matrix.profile }}"
          if [ -n "${{ matrix.options }}" ]; then
            echo "Options: ${{ matrix.options }}"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: conan-build-${{ matrix.profile }}
          path: |
            ~/.conan2/p/*/p/
          retention-days: 7
          if-no-files-found: ignore

  summary:
    needs: [detect-changes, validate-conan, build-conan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Build summary
        run: |
          echo "## ðŸ”¨ Conan Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Conan files: ${{ needs.detect-changes.outputs.conan-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Profiles: ${{ needs.detect-changes.outputs.profiles-changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results" >> $GITHUB_STEP_SUMMARY
          echo "- Validation: ${{ needs.validate-conan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build-conan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Conan CI complete" >> $GITHUB_STEP_SUMMARY
