#!/bin/bash
# Conan Build Script - Developer-friendly wrapper

set -e

# Default values
PROFILE="linux-gcc11"
VERBOSE=""
CLEAN=""
TEST=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--profile)
            PROFILE="$2"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE="-v"
            shift
            ;;
        -c|--clean)
            CLEAN="--clean"
            shift
            ;;
        -t|--test)
            TEST="--test"
            shift
            ;;
        -h|--help)
            echo "Usage: $0 [OPTIONS]"
            echo "Options:"
            echo "  -p, --profile PROFILE    Conan profile to use (default: linux-gcc11)"
            echo "  -v, --verbose           Verbose output"
            echo "  -c, --clean            Clean before build"
            echo "  -t, --test             Run tests after build"
            echo "  -h, --help             Show this help"
            echo ""
            echo "Available profiles:"
            echo "  linux-gcc11, linux-clang15, windows-msvc2022, macos-clang14, debug"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

echo "üî® Building Conan package..."
echo "üìã Profile: $PROFILE"

# Check if profile exists
if [ ! -f "conan-dev/profiles/$PROFILE.profile" ]; then
    echo "‚ùå Profile not found: $PROFILE"
    echo "Available profiles:"
    ls conan-dev/profiles/*.profile | sed 's/.*\///' | sed 's/\.profile$//'
    exit 1
fi

# Clean if requested
if [ -n "$CLEAN" ]; then
    echo "üßπ Cleaning previous build..."
    rm -rf build/ package/
fi

# Build package
echo "üî® Building package..."
conan build . --profile="$PROFILE" $VERBOSE $CLEAN

# Run tests if requested
if [ -n "$TEST" ]; then
    echo "üß™ Running tests..."
    conan test test_package openssl/3.5.0@user/channel --profile="$PROFILE" $VERBOSE
fi

echo "‚úÖ Build complete!"
echo "üìÅ Build artifacts: build/ and package/ directories"